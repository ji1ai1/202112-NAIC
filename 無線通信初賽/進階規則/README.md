# 进阶規則

73.91651570796967
<br /><br /><br /><br />




## 思路
在基线的基础上，分别对分片和增强做了优化。
<br /><br />
分片的方向是每片越小越好。增强的方向是候选片越多越好。同时每片越小，候选片就越多。但是候选片过多会导致运行超时。所以要尽可能提升每个候选片的利用率。
<br /><br />

### 分片
对2, 126, 128的维度分别统计标准差，发现2的维度的两个维度标准差接近，126的维度的标准差呈现中间大两侧小的单峰分布，128的维度以4个为一组，呈现一组小一组大的分布。
<br /><br />
要提升利用率，应使每个候选片的分布尽可能一致。例如若将126的维度切成两片，则(:, 0:63)的片在测试集上也只能用在(:, 0:63)上，(:, 63:126)的片在测试集上也只能用在(:, 63:126)上，利用率不高；
而像基础规则那样将128的维度切成16片，(:, :, 0:8)的片在测试集上不仅能用在(:, :, 0:8)上，也能用在(:, :, 8:16)或是(:, :, 16:32)上，利用率较高。
<br /><br />
因此，对126的维度分片的思路可以排除，另外128的维度只能分成8、16或是32片，而不能是7片、9片等其它数值（实际测试验证了这个结论）。考虑对2的维度和128的维度的分片，有以下几种方式：
* 8×(2, 126, 16) 实测效果较差
* 16×(2, 126, 8) 即基础规则的方式，实测效果较好
* 32×(2, 126, 4) 每个索引用16位保存，候选片空间太小
* 32×(1, 126, 8) 每个索引用16位保存，候选片空间太小

<br />
由于我们还要做一些增强，对候选片进行一些扩充，最终的候选片的数量要在百万数量级，因而索引位应在22位左右。因此基础规则中的16×(2, 126, 8)就是最好的分片方式。但这种方式只用了(16×22=)352位，浪费了160位。因而最终我采用对128的维度混合分片，分成14×4+9×8，即前56维分成14片，后72维分成9片，如此共分成23片，可以用(23×22=)506位。

<br /><br />
### 丢弃边缘
由于126的维度两侧的标准差很接近0，这意味着126的维度两侧大部分值都很接近0.5。为提升效率，可以丢掉该维度的两侧，只保留中间部分，即只取19~66共48维。

<br /><br />
### 增强

除了1-x外，我还尝试了一些方式扩充样本，最终只有下面的增强方式有效：
* x' = 0.5 * x[:, :, 0:8] + 0.5 * x[:, :, 8:16]
* x' = 0.5 * x[:, :, 0:8] + 0.5 * x[:, :, 16:24]
* x' = 0.5 * x[:, :, 8:16] + 0.5 * x[:, :, 16:24]
* ...

这样总共120组。但是将120组全部加入会超时，我选择了其中的一部分加入。

<br /><br />
### 后续优化
当前方案的候选片数大概已经达到上限。若要进一步优化，可能可以从两个方向考虑：
* 提升运行效率，使得候选片数上限提升（我找不到可优化之处）
* 提升候选片的利用率。可以考虑聚类或神经网络等方式（我都有尝试，效果不好）

<br />
